---
- name: Get available storage devices for swap
  set_fact: 
    swap_disk: "{{ swap_disk|default([]) + [device.key] }}"
  when:
     - not device.value.partitions
     - not device.value.holders
     - device.key is search('vd')
     - device.value.size == swap_disk_size
  loop: "{{ ansible_devices | dict2items }}"
  loop_control:
    loop_var: device

- name: Check if the required storage device for swap is found
  fail:
    msg: "Could not find a free {{ swap_disk_size }} storage device for swap"
  when:  swap_disk is not defined

- name: Create a volume group for swap
  lvg:
    vg: "{{ sap_sid|lower }}_swap_vg"
    pvs: "/dev/{{ swap_disk[0] }}"
    pesize: "32"

- name: Get available storage devices for SAP instance
  set_fact: 
    sap_disk: "{{ sap_disk|default([]) + [device.key] }}"
  when:
     - not device.value.partitions
     - not device.value.holders
     - device.key is search('vd')
     - device.value.size == sap_disk_size
  loop: "{{ ansible_devices | dict2items }}"
  loop_control:
    loop_var: device

- name: Check if the required storage device for SAP instance is found
  fail:
    msg: "Could not find a free {{ sap_disk_size }} storage device for SAP instance"
  when:  sap_disk is not defined

- name: Create a volume group for SAP instance
  lvg:
    vg: "{{ sap_sid|lower }}_app_vg"
    pvs: "/dev/{{ sap_disk[0] }}"
    pesize: "32"

- name: Create a logical volume for swap
  lvol:
    vg: "{{ sap_sid|lower }}_swap_vg"
    lv: "{{ sap_sid|lower }}_swap_lv"
    size: "{{ swap_lv_size }}"

- name: Create a logical volume for /usr/sap
  lvol:
    vg: "{{ sap_sid|lower }}_app_vg"
    lv: "{{ sap_sid|lower }}_usrsap_lv"
    size: "{{ usrsap_lv_size }}"

- name: Create a logical volume for /usr/sap/{{ sap_sid|upper }}
  lvol:
    vg: "{{ sap_sid|lower }}_app_vg"
    lv: "{{ sap_sid|lower }}_sap_lv"
    size: "{{ sap_lv_size }}"
...
